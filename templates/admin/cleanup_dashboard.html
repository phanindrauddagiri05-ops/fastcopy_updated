{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}File Cleanup Dashboard{% endblock %}

{% block extrastyle %}
<style>
    .cleanup-dashboard {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .dashboard-header h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
    }
    
    .dashboard-header p {
        margin: 0;
        opacity: 0.9;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .stat-card.warning {
        border-left-color: #f59e0b;
    }
    
    .stat-card.success {
        border-left-color: #10b981;
    }
    
    .stat-card.danger {
        border-left-color: #ef4444;
    }
    
    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #6b7280;
        text-transform: uppercase;
        font-weight: 600;
    }
    
    .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 5px;
    }
    
    .stat-card .label {
        font-size: 14px;
        color: #9ca3af;
    }
    
    .control-panel {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .control-panel h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
        color: #1f2937;
    }
    
    .cleanup-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 5px;
    }
    
    .form-group select,
    .form-group input {
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .form-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-top: 5px;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
    }
    
    .btn-primary:hover {
        background: #5568d3;
    }
    
    .btn-warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-warning:hover {
        background: #d97706;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background: #059669;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .status-table {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .status-table h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
        color: #1f2937;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    
    th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
    }
    
    td {
        color: #6b7280;
        font-size: 14px;
    }
    
    .retention-info {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .retention-info h3 {
        margin: 0 0 10px 0;
        color: #1e40af;
        font-size: 16px;
    }
    
    .retention-info ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .retention-info li {
        color: #1e40af;
        margin-bottom: 5px;
    }
    
    #cleanup-result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        display: none;
    }
    
    #cleanup-result.success {
        background: #d1fae5;
        border: 1px solid #10b981;
        color: #065f46;
    }
    
    #cleanup-result.error {
        background: #fee2e2;
        border: 1px solid #ef4444;
        color: #991b1b;
    }
    
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="cleanup-dashboard">
    <div class="dashboard-header">
        <h1>üóëÔ∏è File Cleanup Dashboard</h1>
        <p>Monitor storage usage and manage automatic file cleanup</p>
    </div>
    
    <!-- Storage Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Storage</h3>
            <div class="value">{{ storage_stats.total_mb }} MB</div>
            <div class="label">All media files</div>
        </div>
        
        <div class="stat-card warning">
            <h3>Order Files (PDFs)</h3>
            <div class="value">{{ storage_stats.orders_pdfs_mb }} MB</div>
            <div class="label">PDF documents</div>
        </div>
        
        <div class="stat-card success">
            <h3>Order Files (Images)</h3>
            <div class="value">{{ storage_stats.orders_images_mb }} MB</div>
            <div class="label">Image uploads</div>
        </div>
        
        <div class="stat-card danger">
            <h3>Cleanup Potential</h3>
            <div class="value">{{ potential_savings_mb }} MB</div>
            <div class="label">{{ total_eligible }} orders eligible</div>
        </div>
    </div>
    
    <!-- Retention Policies -->
    <div class="retention-info">
        <h3>üìã Retention Policies</h3>
        <ul>
            <li><strong>Delivered orders:</strong> Files deleted after {{ retention_policies.delivered }} days</li>
            <li><strong>Cancelled/Rejected orders:</strong> Files deleted after {{ retention_policies.cancelled }} days</li>
            <li><strong>Failed payment orders:</strong> Files deleted after {{ retention_policies.failed }} days</li>
            <li><strong>Temporary files:</strong> Deleted after {{ retention_policies.temp }} day(s)</li>
            <li><strong>Pending/Confirmed/Ready orders:</strong> Files never deleted</li>
        </ul>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <h2>üéõÔ∏è Cleanup Control Panel</h2>
        
        <form id="cleanup-form" class="cleanup-form">
            <div class="form-group">
                <label for="status-filter">Filter by Status</label>
                <select id="status-filter" name="status">
                    <option value="">All Eligible</option>
                    <option value="Delivered">Delivered Only</option>
                    <option value="Cancelled">Cancelled Only</option>
                    <option value="Rejected">Rejected Only</option>
                    <option value="Failed">Failed Payment Only</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="retention-days">Custom Retention (Days)</label>
                <input type="number" id="retention-days" name="days" placeholder="Default policy" min="1">
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="include-temp" name="include_temp" checked>
                    Include temp files
                </label>
            </div>
        </form>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="runCleanup(true)">
                üîç Preview Cleanup (Dry Run)
            </button>
            <button class="btn btn-warning" onclick="runCleanup(false)">
                üóëÔ∏è Run Actual Cleanup
            </button>
            <button class="btn btn-success" onclick="refreshStats()">
                üîÑ Refresh Statistics
            </button>
            <button class="btn btn-secondary" onclick="downloadReport()">
                üì• Download Report
            </button>
        </div>
        
        <div id="cleanup-result"></div>
    </div>
    
    <!-- Order Statistics -->
    <div class="status-table">
        <h2>üìä Order Statistics</h2>
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Total Orders</th>
                    <th>With Files</th>
                    <th>Without Files</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for item in status_breakdown %}
                <tr>
                    <td><strong>{{ item.status }}</strong></td>
                    <td>{{ item.total }}</td>
                    <td>{{ item.with_files }}</td>
                    <td>{{ item.without_files }}</td>
                    <td>
                        {% if item.total > 0 %}
                            {{ item.with_files|floatformat:0 }}%
                        {% else %}
                            0%
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <tr style="background: #f9fafb; font-weight: bold;">
                    <td>TOTAL</td>
                    <td>{{ total_orders }}</td>
                    <td>{{ orders_with_files }}</td>
                    <td>{{ orders_without_files }}</td>
                    <td>
                        {% if total_orders > 0 %}
                            {% widthratio orders_with_files total_orders 100 %}%
                        {% else %}
                            0%
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function runCleanup(dryRun) {
    const resultDiv = document.getElementById('cleanup-result');
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span> Processing...';
    
    // Get form data
    const status = document.getElementById('status-filter').value;
    const days = document.getElementById('retention-days').value;
    const includeTemp = document.getElementById('include-temp').checked;
    
    // Confirm if not dry run
    if (!dryRun) {
        if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete files!\n\nOrder data will be preserved, but files will be deleted.\n\nAre you sure you want to continue?')) {
            button.disabled = false;
            button.innerHTML = originalText;
            return;
        }
    }
    
    // Make AJAX request
    fetch('/admin/cleanup/run/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            dry_run: dryRun,
            status: status || null,
            days: days || null,
            include_temp: includeTemp
        })
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.innerHTML = originalText;
        
        if (data.success) {
            resultDiv.className = 'success';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>‚úÖ ${data.message}</h3>
                <p><strong>Orders eligible:</strong> ${data.stats.total_orders_eligible}</p>
                <p><strong>Orders processed:</strong> ${data.stats.orders_processed}</p>
                <p><strong>Files deleted:</strong> ${data.stats.total_files_deleted}</p>
                <p><strong>Storage freed:</strong> ${data.stats.total_size_freed_mb} MB</p>
                <p><strong>Failed deletions:</strong> ${data.stats.failed_deletions}</p>
                ${dryRun ? '<p style="color: #f59e0b;"><strong>‚ö†Ô∏è This was a DRY RUN - No files were actually deleted</strong></p>' : ''}
            `;
            
            // Refresh stats if actual cleanup
            if (!dryRun) {
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        } else {
            resultDiv.className = 'error';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<h3>‚ùå Error</h3><p>${data.error}</p>`;
        }
    })
    .catch(error => {
        button.disabled = false;
        button.innerHTML = originalText;
        resultDiv.className = 'error';
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<h3>‚ùå Error</h3><p>${error.message}</p>`;
    });
}

function refreshStats() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span> Refreshing...';
    
    fetch('/admin/cleanup/refresh-stats/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.innerHTML = originalText;
        
        if (data.success) {
            window.location.reload();
        }
    })
    .catch(error => {
        button.disabled = false;
        button.innerHTML = originalText;
        alert('Error refreshing stats: ' + error.message);
    });
}

function downloadReport() {
    window.location.href = '/admin/cleanup/download-report/';
}
</script>
{% endblock %}
